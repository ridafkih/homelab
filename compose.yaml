services:
  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    container_name: caddy
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile
      - .data/caddy/srv:/srv
      - .data/caddy/data:/data
      - .data/caddy/config:/config
    environment:
      DOMAIN: ${CADDY_DOMAIN}
      CLOUDFLARE_API_TOKEN: ${CADDY_CLOUDFLARE_API_TOKEN}
      HOST_MACHINE_HOSTNAME: ${CADDY_HOST_MACHINE_HOSTNAME}
    networks:
      - homelab-network

  pihole:
    container_name: pihole
    network_mode: host
    image: pihole/pihole:latest
    restart: unless-stopped
    environment:
      TZ: ${PIHOLE_TZ}
      FTLCONF_webserver_api_password: ${PIHOLE_FTLCONF_WEBSERVER_API_PASSWORD}
      FTLCONF_webserver_port: ${PIHOLE_FTLCONF_WEBSERVER_PORT}
    volumes:
      - .data/pihole:/etc/pihole

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    volumes:
      - .data/jellyfin/config:/config
      - .data/jellyfin/cache:/cache
      - /data/media/:/media:ro
    restart: always
    runtime: nvidia
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
    networks:
      - homelab-network

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    volumes:
      - .data/ollama/root/.ollama:/root/.ollama
    runtime: nvidia
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
      CONTEXT_LENGTH: ${OLLAMA_CONTEXT_LENGTH}
    networks:
      - homelab-network

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - .data/open-webui/app/backend/data:/app/backend/data
    restart: always
    networks:
      - homelab-network

networks:
  homelab-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
